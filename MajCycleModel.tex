\documentclass[useAMS,usenatbib,referee]{article}
\usepackage{amsmath}
\usepackage{microtype}
\usepackage{mathptmx}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{captcont}
\usepackage[colorlinks=true,citecolor=blue]{hyperref}
\usepackage{emaxima}
\usepackage{natbib}

\newcommand{\unit}[1]{\mathrm{#1}}
\newcommand{\unitp}[2]{\ensuremath{\mathrm{#1}^{#2}}}

\title{Computational Requirements for SDP\\
  Rev: \input{|"git describe --dirty"}}
\author{B. Nikolic\\
  Astrophysics Group, Cavendish Laboratory, Cambridge CB3 0HE, UK
  \\\url{email:b.nikolic@mrao.cam.ac.uk}
 \\\url{http://www.mrao.cam.ac.uk/~bn204/}}

\begin{document}

\maketitle

\tableofcontents

\section{Scope of this document}

This document estimates the computational requirements for the SDP for
each of the SKA telescopes. The estimate is made in terms of FLOPS:
floating point operations per second.

The estimate is currently provisional and subject to revision due to
both improvements in our knowledge and inevitable discovery of errors
of method or incorrect approximations in the calculations.

We currently only consider the computational cost of the `major
cycle', i.e., the formation of dirty sky image from the visibilities
and the reverse step of estimating model visibilities from a trial sky
brightness distribution. We do not take into account `minor-cycle'
(i.e, image-plane deconvolution), flagging, calibration, point source
finding or other data processing.

We currently do not estimate the memory requirements or data transfer
rates for the calculations.


\section{Description of algorithms}

We proceed on assumption that the estimation of both the trial sky
brightness distribution (`back step') and of the model visibilities
(`forward step') will include correction of both A and $w$ terms by
convolution in the $uv$ plane. See \cite{Cornwell2008-4703511},
\cite{Hymphreys132}, \cite{2012SPIE.8500E..0LC},
\cite{2008A&A...487..419B}.

It is shown by \cite{Hymphreys132} that the required size of
convolution kernel to adequately correct for the $w$ term is
approximately $w \Theta_{\rm FoV}$. In general case $w$ can be as
large as $B_{\rm max}/\lambda$ and as usual $\Theta_{\rm FoV} \sim
\lambda/ D_{\rm s}$ giving un-feasibly large kernels of size $B_{\rm
  max}/D_{\rm s}$ \citep[see discussion in][which is somewhat
difficult to follow but is along these lines]{Kogan2012-VLA164}. For
this reason it is assumed that the snapshot technique will be
employed.

In current version of this computation each snapshot is assumed to
require one FFT and one re-projection. The costs of computing PSFs etc
are not accounted for. The relation for duration of snapshots is given
below. 


\section{Computations}

\subsection{Telescope information}

We use the following basic information about the telescopes. This is
based on \cite{DewdneyDD001-1} with its addendum \cite{McCoolDD003}.
No baseline dependent averaging is assumed.
\begin{maxima}[]
SKA1Low : [ tdump = 0.6 `s, Na = 1024 , Nf= 256000, Nbeam=1, Ds=35`m,
lambda = constvalue(%c) / (100e6`Hz) , Bmax = 100e3`m, NAA=9];
SKA1Mid : [ tdump = 0.08 `s, Na = 190+64 , Nf= 256000, Nbeam=1, Ds=15`m,
lambda=constvalue(%c) / (1160e6`Hz) , Bmax = 200e3`m, NAA=9];
SKA1Survey: [tdump = 0.3`s, Na=96, Nf=256000, Nbeam=36,      Ds=15`m,
lambda=constvalue(%c) / (1160e6`Hz) , Bmax = 50e3`m, NAA=9];
\maximaoutput*
\m  \left[ t_{\rm dump}=0.6\;\mathrm{s} , N_{\rm a}=1024 , N_{\rm f}=256000 , N_{\rm beam}=1 , D_{\rm s}=35\;\mathrm{m} , \lambda=3.0\;{{\mathrm{m}}\over{\mathrm{s}\,\mathrm{Hz}}} , B_{\rm max}=100000.\;\mathrm{m} , N_{\rm AA}=9 \right] \\
\m  \left[ t_{\rm dump}=0.08\;\mathrm{s} , N_{\rm a}=254 , N_{\rm f}=256000 , N_{\rm beam}=1 , D_{\rm s}=15\;\mathrm{m} , \lambda=.26\;{{\mathrm{m}}\over{\mathrm{s}\,\mathrm{Hz}}} , B_{\rm max}=200000.\;\mathrm{m} , N_{\rm AA}=9 \right] \\
\m  \left[ t_{\rm dump}=0.3\;\mathrm{s} , N_{\rm a}=96 , N_{\rm f}=256000 , N_{\rm beam}=36 , D_{\rm s}=15\;\mathrm{m} , \lambda=.26\;{{\mathrm{m}}\over{\mathrm{s}\,\mathrm{Hz}}} , B_{\rm max}=50000.\;\mathrm{m} , N_{\rm AA}=9 \right] \\
\end{maxima}
Here $\lambda$ is a representative wavelength for calculation below.
The calculations are made at this wavelength and not fully integrated
over the bands of the telescope.

\subsection{Image size}

The sizes of images to be produced can be estimated as follows:

\begin{maxima}[]
QPix:  2 ;
NPix : QPix * 2 * Bmax/ Ds / Nfacet;

calcTel(NPix, SKA1Low);
calcTel(NPix, SKA1Mid);
calcTel(NPix, SKA1Survey);
\maximaoutput*
\m  2 \\
\m  {{4\,B_{\rm max}}\over{D_{\rm s}\,N_{\rm facet}}} \\
\m  \mathrm{NPix(SKA1Low)}={{11429.}\over{N_{\rm facet}}} \\
\m  \mathrm{NPix(SKA1Mid)}={{53333.}\over{N_{\rm facet}}} \\
\m  \mathrm{NPix(SKA1Survey)}={{13333.}\over{N_{\rm facet}}} \\
\end{maxima}

The size of $uv$-grids is assumed to be the same. 

\subsection{Snapshot duration}

Worst case scenario is that that the baseline is rotating exactly in
$w$ direction, therefore maximum $w$ rate of deviation is:
\begin{maxima}[]
We: 7.27e-5 ` (1/s); 
DeltaW : Bmax* We/2;

calcTel(DeltaW, SKA1Low);
calcTel(DeltaW, SKA1Mid);
calcTel(DeltaW, SKA1Survey);

\maximaoutput*
\m  7.27 \times 10^{-5}\;{{1}\over{\mathrm{s}}} \\
\m  3.64 \times 10^{-5}\,B_{\rm max}\;{{1}\over{\mathrm{s}}} \\
\m  \mathrm{DeltaW(SKA1Low)}=3.6\;{{\mathrm{m}}\over{\mathrm{s}}} \\
\m  \mathrm{DeltaW(SKA1Mid)}=7.3\;{{\mathrm{m}}\over{\mathrm{s}}} \\
\m  \mathrm{DeltaW(SKA1Survey)}=1.8\;{{\mathrm{m}}\over{\mathrm{s}}} \\
\end{maxima}

Generalising \cite{Hymphreys132} the size of convolution kernel
required to correct for $w$-term is $Q_{w} \Delta w / (D*N_{\rm facet}) $. Therefore
if we assume the size of convolution kernel as $N_{\rm GW}$, then we can compute
duration of snapshot as:
\begin{maxima}[]
Qw:1;
twsnap:  (NGW*Ds*Nfacet)/ (Qw* DeltaW) ;

calcTel(twsnap, SKA1Low);
calcTel(twsnap, SKA1Mid);
calcTel(twsnap, SKA1Survey);

\maximaoutput*
\m  1 \\
\m  {{27510.\,D_{\rm s}\,N_{\rm facet}\,N_{\rm GW}}\over{B_{\rm max}}}\;\mathrm{s} \\
\m  \mathrm{twsnap(SKA1Low)}=9.6\,N_{\rm facet}\,N_{\rm GW}\;\mathrm{s} \\
\m  \mathrm{twsnap(SKA1Mid)}=2.1\,N_{\rm facet}\,N_{\rm GW}\;\mathrm{s} \\
\m  \mathrm{twsnap(SKA1Survey)}=8.3\,N_{\rm facet}\,N_{\rm GW}\;\mathrm{s} \\
\end{maxima}

\subsection{Visibility rate}

The rate at which the SDP receives visibilities is:

\begin{maxima}[]
Nbl       :  Na * (Na-1)/2 * Nf * Nbeam* 4;
VisInRate : Nbl / tdump ;

calcTel(VisInRate, SKA1Low);
calcTel(VisInRate, SKA1Mid);
calcTel(VisInRate, SKA1Survey);
\maximaoutput*
\m  2\,\left(N_{\rm a}-1\right)\,N_{\rm a}\,N_{\rm beam}\,N_{\rm f} \\
\m  {{2\,\left(N_{\rm a}-1\right)\,N_{\rm a}\,N_{\rm beam}\,N_{\rm f}}\over{t_{\rm dump}}} \\
\m  \mathrm{VisInRate(SKA1Low)}=8.9 \times 10^{+11}\;{{1}\over{\mathrm{s}}} \\
\m  \mathrm{VisInRate(SKA1Mid)}=4.1 \times 10^{+11}\;{{1}\over{\mathrm{s}}} \\
\m  \mathrm{VisInRate(SKA1Survey)}=5.6 \times 10^{+11}\;{{1}\over{\mathrm{s}}} \\
\end{maxima} 

This takes into account 4 polarisation products and  the multiple
beams for SKA1 Survey.

\subsection{FFT Rate}

Assuming 1 FFT per snapshot per polarisation product per frequency
channel per beam we get the FLOP rate for FFTs:
\begin{maxima}[]
FFTRate : (5 `Ops) * NPix **2 * log2(NPix **2)  * Nf * Nbeam * 4 * Nfacet**2 /
twsnap ;

calcTel(FFTRate, SKA1Low);
calcTel(FFTRate, SKA1Mid);
calcTel(FFTRate, SKA1Survey);

ev(FFTRate, append([Nfacet=1],SKA1Low));
ev(FFTRate, append([Nfacet=1],SKA1Mid));
ev(FFTRate, append([Nfacet=1],SKA1Survey));

\maximaoutput*
\m  {{.012\,B_{\rm max}^3\,N_{\rm beam}\,N_{\rm f}\,\log \left({{16\,B_{\rm max}^2}\over{D_{\rm s}^2\,N_{\rm facet}^2}}\right)}\over{\log 2\,D_{\rm s}^3\,N_{\rm facet}\,N_{\rm GW}}}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  \mathrm{FFTRate(SKA1Low)}={{1.0 \times 10^{+14}\,\log \left({{1.31 \times 10^{+8}}\over{N_{\rm facet}^2}}\right)}\over{N_{\rm facet}\,N_{\rm GW}}}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  \mathrm{FFTRate(SKA1Mid)}={{1.0 \times 10^{+16}\,\log \left({{2.84 \times 10^{+9}}\over{N_{\rm facet}^2}}\right)}\over{N_{\rm facet}\,N_{\rm GW}}}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  \mathrm{FFTRate(SKA1Survey)}={{5.7 \times 10^{+15}\,\log \left({{1.78 \times 10^{+8}}\over{N_{\rm facet}^2}}\right)}\over{N_{\rm facet}\,N_{\rm GW}}}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  {{1.3 \times 10^{+15}}\over{\log 2\,N_{\rm GW}}}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  {{1.5 \times 10^{+17}}\over{\log 2\,N_{\rm GW}}}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  {{7.5 \times 10^{+16}}\over{\log 2\,N_{\rm GW}}}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\end{maxima}

\subsection{Reprojection rate}

In the snapshot technique each snapshot has to be re-projected to a
common coordinate system. If it is assumed that 50 FLOP are required
per pixel to reproject we can get following required rate:

\begin{maxima}[]
ReProjRate : (50 `Ops ) * NPix**2 * Nf * Nbeam * 4 * Nfacet**2 / twsnap;

calcTel(ReProjRate, SKA1Low);
calcTel(ReProjRate, SKA1Mid);
calcTel(ReProjRate, SKA1Survey);


\maximaoutput*
\m  {{.12\,B_{\rm max}^3\,N_{\rm beam}\,N_{\rm f}}\over{D_{\rm s}^3\,N_{\rm facet}\,N_{\rm GW}}}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  \mathrm{ReProjRate(SKA1Low)}={{6.9 \times 10^{+14}}\over{N_{\rm facet}\,N_{\rm GW}}}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  \mathrm{ReProjRate(SKA1Mid)}={{7.1 \times 10^{+16}}\over{N_{\rm facet}\,N_{\rm GW}}}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  \mathrm{ReProjRate(SKA1Survey)}={{4.0 \times 10^{+16}}\over{N_{\rm facet}\,N_{\rm GW}}}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\end{maxima}

\subsection{Gridding rate}


\begin{maxima}[]
GridRate   : VisInRate * (NAA**2+NGW**2) * (8 `Ops) * Nfacet**2;

calcTel(GridRate, SKA1Low);
calcTel(GridRate, SKA1Mid);
calcTel(GridRate, SKA1Survey);

ev(GridRate, append([Nfacet=1],SKA1Low));
ev(GridRate, append([Nfacet=1],SKA1Mid));
ev(GridRate, append([Nfacet=1],SKA1Survey));

\maximaoutput*
\m  {{16\,\left(N_{\rm a}-1\right)\,N_{\rm a}\,N_{\rm beam}\,N_{\rm f}\,N_{\rm facet}^2\,\left(N_{\rm GW}^2+N_{\rm AA}^2\right)}\over{t_{\rm dump}}}\;\mathrm{Ops} \\
\m  \mathrm{GridRate(SKA1Low)}=7.2 \times 10^{+12}\,N_{\rm facet}^2\,\left(N_{\rm GW}^2+81.\right)\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  \mathrm{GridRate(SKA1Mid)}=3.3 \times 10^{+12}\,N_{\rm facet}^2\,\left(N_{\rm GW}^2+81.\right)\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  \mathrm{GridRate(SKA1Survey)}=4.5 \times 10^{+12}\,N_{\rm facet}^2\,\left(N_{\rm GW}^2+81.\right)\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  7.2 \times 10^{+12}\,\left(N_{\rm GW}^2+81\right)\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  3.3 \times 10^{+12}\,\left(N_{\rm GW}^2+81\right)\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  4.5 \times 10^{+12}\,\left(N_{\rm GW}^2+81\right)\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\end{maxima}

\subsection{Phase Rotation -- preliminary}

In the case of multi-facet imaging, it is necessary to phase rotate
visibilities to each new imaging plane. A first estimate of this can
be made as:

\begin{maxima}[]
PhaseRotateRate   : VisInRate * (20 `Ops) * Nfacet**2;
\maximaoutput*
\m  {{40\,\left(N_{\rm a}-1\right)\,N_{\rm a}\,N_{\rm beam}\,N_{\rm f}\,N_{\rm facet}^2}\over{t_{\rm dump}}}\;\mathrm{Ops} \\
\end{maxima}

Allowing for 20 operations to compute the sine/cosine and do the
multiplication.

\begin{maxima}[]
ev(PhaseRotateRate, append([Nfacet=2 * Bmax/ Ds], SKA1Low), infeval);
ev(PhaseRotateRate, append([Nfacet=2 * Bmax/ Ds], SKA1Mid), infeval);
\maximaoutput*
\m  5.8 \times 10^{+20}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  5.8 \times 10^{+21}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\end{maxima}

\subsection{Computing requirement}

Total compute rate is then given by:
\begin{maxima}[]
CompRate : FFTRate+ ReProjRate+ GridRate;

calcTel(CompRate, SKA1Low);
calcTel(CompRate, SKA1Mid);
calcTel(CompRate, SKA1Survey);
\maximaoutput*
\m  \mathrm{CompRate(SKA1Low)}=\left(7.2 \times 10^{+12}\,N_{\rm facet}^2\,\left(N_{\rm GW}^2+81.\right)+{{1.0 \times 10^{+14}\,\log \left({{1.31 \times 10^{+8}}\over{N_{\rm facet}^2}}\right)}\over{N_{\rm facet}\,N_{\rm GW}}}+{{6.9 \times 10^{+14}}\over{N_{\rm facet}\,N_{\rm GW}}}\right)\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  \mathrm{CompRate(SKA1Mid)}=\left(3.3 \times 10^{+12}\,N_{\rm facet}^2\,\left(N_{\rm GW}^2+81.\right)+{{1.0 \times 10^{+16}\,\log \left({{2.84 \times 10^{+9}}\over{N_{\rm facet}^2}}\right)}\over{N_{\rm facet}\,N_{\rm GW}}}+{{7.1 \times 10^{+16}}\over{N_{\rm facet}\,N_{\rm GW}}}\right)\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  \mathrm{CompRate(SKA1Survey)}=\left(4.5 \times 10^{+12}\,N_{\rm facet}^2\,\left(N_{\rm GW}^2+81.\right)+{{5.7 \times 10^{+15}\,\log \left({{1.78 \times 10^{+8}}\over{N_{\rm facet}^2}}\right)}\over{N_{\rm facet}\,N_{\rm GW}}}+{{4.0 \times 10^{+16}}\over{N_{\rm facet}\,N_{\rm GW}}}\right)\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\end{maxima}
This is the compute rate per half-major cycle (i.e., per forward step
or backward step).


\subsection{Optimal gridding kernel size}

We can find the optimum w-kernel size for each telescope by finding
the stationary points of the CompRate function wrt to the size of the
kernels:
\begin{maxima}[]
float(solve(diff(ev(CompRate, SKA1Low, Nfacet=1) / ( 1` (Ops/s)), NGW), NGW));
float(solve(diff(ev(CompRate, SKA1Mid, Nfacet=1) / ( 1` (Ops/s)), NGW), NGW));
float(solve(diff(ev(CompRate, SKA1Survey, Nfacet=1) / ( 1` (Ops/s)), NGW), NGW));
\maximaoutput*
\m  \left[ N_{\rm GW}=2.8\,\left(1.7\,i-1.0\right) , N_{\rm GW}=-2.8\,\left(1.7\,i+1.0\right) , N_{\rm GW}=5.6 \right] \\
\m  \left[ N_{\rm GW}=18.\,\left(1.7\,i-1.0\right) , N_{\rm GW}=-18.\,\left(1.7\,i+1.0\right) , N_{\rm GW}=35. \right] \\
\m  \left[ N_{\rm GW}=13.\,\left(1.7\,i-1.0\right) , N_{\rm GW}=-13.\,\left(1.7\,i+1.0\right) , N_{\rm GW}=25. \right] \\
\end{maxima}
Obviously the real solutions (printed rightmost) are the ones with
physical meaning.


\subsection{Compute rate at optimal kernel size}
\label{sec:wsnapshot-opt-rate}

If we take the optimised convolution kernel sizes from above the
section above we get total compute rates as:

\begin{maxima}[]
ev(float(CompRate), append([NGW=6, Nfacet=1],  SKA1Low) );
ev(float(CompRate), append([Nfacet=1 , NGW=35],  SKA1Mid) );
ev(float(CompRate), append([ NGW=25, Nfacet=1],  SKA1Survey) );
\maximaoutput*
\m  1.3 \times 10^{+15}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  1.3 \times 10^{+16}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  9.1 \times 10^{+15}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\end{maxima}
again this is per half-major cycle.

One thing to note is that kernel size of $\sqrt(9^2+7^2)\sim 11$ will
likely not be enough to capture the A term for SKA1 Low. It may
therefore be necessary to use kernels which are larger than this for
SKA1 Low, leading to higher computational load. 

\section{Working memory and computational intensity}

\subsection{Computational intensity}

A crude first estimate of the computational intensity can be estimated
as the ratio of the largest data set (the visibilities) and the
processing computing requirements computed estimated above.

Note that: 
\begin{itemize}
\item Here I assume 8 bytes per visibility which assumes a very
  efficient data format, a conservative estimate would be at least 16
  bytes
\item The division is of the visibility rate vs half-cycle compute
  requirements. This number is therefore independent of the number of
  cycles
\end{itemize}

\begin{maxima}[]
CompIntens1: CompRate /  (VisInRate * 8 `byte);

ev(float(CompIntens1), append([ NGW=6, Nfacet=1],  SKA1Low));
ev(float(CompIntens1), append([Nfacet=1 , NGW=35],  SKA1Mid) );
ev(float(CompIntens1), append([ NGW=25, Nfacet=1],  SKA1Survey) );
\maximaoutput*
\m  \left({{\left(N_{\rm a}-1\right)^ {- 1 }\,N_{\rm a}^ {- 1 }\,N_{\rm beam}^ {- 1 }\,N_{\rm f}^ {- 1 }\,t_{\rm dump}}\over{16}}\;{{1}\over{\mathrm{byte}}}\right)\,\left({{16\,\left(N_{\rm a}-1\right)\,N_{\rm a}\,N_{\rm beam}\,N_{\rm f}\,N_{\rm facet}^2\,\left(N_{\rm GW}^2+N_{\rm AA}^2\right)}\over{t_{\rm dump}}}\;\mathrm{Ops}+\left({{.012\,B_{\rm max}^3\,N_{\rm beam}\,N_{\rm f}\,\log \left({{16\,B_{\rm max}^2}\over{D_{\rm s}^2\,N_{\rm facet}^2}}\right)}\over{\log 2\,D_{\rm s}^3\,N_{\rm facet}\,N_{\rm GW}}}+{{.12\,B_{\rm max}^3\,N_{\rm beam}\,N_{\rm f}}\over{D_{\rm s}^3\,N_{\rm facet}\,N_{\rm GW}}}\right)\;{{\mathrm{Ops}}\over{\mathrm{s}}}\right) \\
\m  177.\;{{\mathrm{Ops}}\over{\mathrm{byte}}} \\
\m  3844.\;{{\mathrm{Ops}}\over{\mathrm{byte}}} \\
\m  2031.\;{{\mathrm{Ops}}\over{\mathrm{byte}}} \\
\end{maxima}

\section{Computing the convolution kernels}

Computing the convolution functions is a fairly complex process which
in detail depends on the effects that are corrected for using the
convolution function in the $uv$-plane. However, the major
computational complexity arises if the convolution functions need to
be computed on a baseline-by-baseline basis to account for the
different $A$ responses of the two receiving elements forming the
baseline.  In this case the major computational cost is the FFT
between the image plane where combination of effects is done by
multiplication.  The computational cost can therefore be estimated as:

\begin{maxima}[]
gcfc1 : [NGCF = sqrt(NAA**2+NGW**2),
         FNGCF = Qgcf * NGCF] ;
gcfrate : (5 `Ops) *  (FNGCF ** 2) * log2(FNGCF ** 2)  / Tion * Nbl *
Qfcv / 10 *
Nfacet**2;

ev( gcfrate, append([Qgcf=8, Qfcv=1], gcfc1),infeval);
ev( gcfrate/ GridRate, append([Qgcf=8, NAA=9, Qfcv=1],gcfc1),
infeval);

\maximaoutput*
\m  \left[ \mathrm{NGCF}=\sqrt{N_{\rm GW}^2+N_{\rm AA}^2} , \mathrm{FNGCF}=\mathrm{Qgcf}\,\mathrm{NGCF} \right] \\
\m  {{2\,\left(N_{\rm a}-1\right)\,N_{\rm a}\,N_{\rm beam}\,N_{\rm f}\,N_{\rm facet}^2\,\mathrm{Qfcv}\,\mathrm{FNGCF}^2\,\log \mathrm{FNGCF}}\over{\log 2\,t_{\rm ionsph}}}\;\mathrm{Ops} \\
\m  {{128\,\left(N_{\rm a}-1\right)\,N_{\rm a}\,N_{\rm beam}\,N_{\rm f}\,N_{\rm facet}^2\,\left(N_{\rm GW}^2+N_{\rm AA}^2\right)\,\log \left(8\,\sqrt{N_{\rm GW}^2+N_{\rm AA}^2}\right)}\over{\log 2\,t_{\rm ionsph}}}\;\mathrm{Ops} \\
\m  {{8\,t_{\rm dump}\,\log \left(8\,\sqrt{N_{\rm GW}^2+81}\right)}\over{\log 2\,t_{\rm ionsph}}} \\
\end{maxima}

The ratio of operation count for imaging (FFT+Reprojection+Gridding)
to operation count for the convolution kernel can be expressed as
function of the ionospheric timescale:

\begin{maxima}[]
float(ev( gcfrate/ GridRate, 
          append([Qgcf=8, NAA=9, Qfcv=1,NGW=6],gcfc1,SKA1Low), infeval));
float(ev( gcfrate/ GridRate, 
          append([Qgcf=8, NAA=9, Qfcv=1,NGW=35],gcfc1,SKA1Mid), infeval));
float(ev( gcfrate/ GridRate, 
          append([Qgcf=8, NAA=9, Qfcv=1,NGW=25],gcfc1,SKA1Survey), infeval));
\maximaoutput*
\m  {{31.}\over{t_{\rm ionsph}}}\;\mathrm{s} \\
\m  {{5.2}\over{t_{\rm ionsph}}}\;\mathrm{s} \\
\m  {{19.}\over{t_{\rm ionsph}}}\;\mathrm{s} \\
\end{maxima}

The operation rate as function  of ionospheric timescale is given by:
\begin{maxima}[]
float(ev( gcfrate, 
          append(gcfc1, [NGW=6, Nfacet=1,  Qgcf=8,Qfcv=1, NAA=9]  , SKA1Low), infeval));
float(ev( gcfrate, 
          append(gcfc1, [NGW=35, Nfacet=1,  Qgcf=8, Qfcv=1,NAA=9]  , SKA1Mid), infeval));
float(ev( gcfrate, 
          append(gcfc1, [NGW=25, Nfacet=1, Qgcf=8, Qfcv=1,NAA=9]  , SKA1Survey), infeval));
\maximaoutput*
\m  {{2.6 \times 10^{+16}}\over{t_{\rm ionsph}}}\;\mathrm{Ops} \\
\m  {{2.2 \times 10^{+16}}\over{t_{\rm ionsph}}}\;\mathrm{Ops} \\
\m  {{5.9 \times 10^{+16}}\over{t_{\rm ionsph}}}\;\mathrm{Ops} \\
\end{maxima}

If we assume 60 second ionospheric time rate, we get following
operation rates (per half-major-cycle as everywhere).
\begin{maxima}[]
float(ev( gcfrate, append(gcfc1, [NGW=6, Nfacet=1, Tion= 60`s, Qgcf=8,Qfcv=1, NAA=9]  , SKA1Low), infeval));
float(ev( gcfrate, append(gcfc1, [NGW=35, Nfacet=1, Tion= 60`s, Qgcf=8, Qfcv=1,NAA=9]  , SKA1Mid), infeval));
float(ev( gcfrate, append(gcfc1, [NGW=25, Nfacet=1, Tion= 60`s,
Qgcf=8, Qfcv=1,NAA=9]  , SKA1Survey), infeval));
\maximaoutput*
\m  4.3 \times 10^{+14}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  3.7 \times 10^{+14}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  9.8 \times 10^{+14}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\end{maxima}


\section{Alternative to snapshots: W-stacking}

For outline on ``w-stacking'' see also
\cite{VoronkovCalim2010Gridding}, and \cite{2013A&A...553A.105T}. The
concept of this technique is that visibilities with different values
of the $w$ coordinate are not combined in the $uv$ domain but rather
gridded separately and transformed into the image (maybe we should be
calling it the ``$lm$''?) domain, corrected for the $w$ term and then
combined. This obviously requires a degree of sorting of the data in
the $w$ dimension.

Compared to snapshots:
\begin{enumerate}
  \item The input visibility rate is the same. The cost of sorting the
    data is not considered in this section.
  \item The whole observation is processed together. The largest $w$
    that needs to be corrected is controlled by (half) the separation
    of the $w$ planes
  \item No re-projection like in $w$-snapshots is needed but instead a
    correction of the $w$ term is required for each plane after the
    FFT to image plane
  \item Number of FFTs is the same as number w planes
\end{enumerate}

\subsection{Computational load calculation}


\subsubsection{Size of convolution kernel}

The size of the required convolution is controlled by the largest
residual w-term after assigning each visibility to the nearest $w$
plane. To be consistent with previous sections we assume $w$-plane are
equidistant and the largest $w$ is simply half the distance between
the planes.  This gives the relationship between the size of kernel
and number of $w$-lanes.

\begin{maxima}[]
wsDeltaW : Bmax / 2 / wsNWPlanes;
wsNGW :  (Qw * wsDeltaW ) / Ds / Nfacet;

calcTel(wsNGW, SKA1Low);
calcTel(wsNGW, SKA1Mid);
calcTel(wsNGW, SKA1Survey);

\maximaoutput*
\m  {{B_{\rm max}}\over{2\,\mathrm{wsNWPlanes}}} \\
\m  {{B_{\rm max}}\over{2\,D_{\rm s}\,N_{\rm facet}\,\mathrm{wsNWPlanes}}} \\
\m  \mathrm{wsNGW(SKA1Low)}={{1429.}\over{N_{\rm facet}\,\mathrm{wsNWPlanes}}} \\
\m  \mathrm{wsNGW(SKA1Mid)}={{6667.}\over{N_{\rm facet}\,\mathrm{wsNWPlanes}}} \\
\m  \mathrm{wsNGW(SKA1Survey)}={{1667.}\over{N_{\rm facet}\,\mathrm{wsNWPlanes}}} \\
\end{maxima}

\subsubsection{Gridding}

The gridding rate is as before controlled simply by the size of the
convolution kernel and the input data rate, plus any faceting.

\begin{maxima}[]
wsGridRate   : VisInRate * (NAA**2+wsNGW**2) * (4 `Ops) * Nfacet**2;

calcTel(wsGridRate, SKA1Low);
calcTel(wsGridRate, SKA1Mid);
calcTel(wsGridRate, SKA1Survey);

\maximaoutput*
\m  {{8\,\left(N_{\rm a}-1\right)\,N_{\rm a}\,N_{\rm beam}\,N_{\rm f}\,N_{\rm facet}^2\,\left({{B_{\rm max}^2}\over{4\,D_{\rm s}^2\,N_{\rm facet}^2\,\mathrm{wsNWPlanes}^2}}+N_{\rm AA}^2\right)}\over{t_{\rm dump}}}\;\mathrm{Ops} \\
\m  \mathrm{wsGridRate(SKA1Low)}=3.6 \times 10^{+12}\,N_{\rm facet}^2\,\left({{2040816.}\over{N_{\rm facet}^2\,\mathrm{wsNWPlanes}^2}}+81.\right)\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  \mathrm{wsGridRate(SKA1Mid)}=1.6 \times 10^{+12}\,N_{\rm facet}^2\,\left({{4.44 \times 10^{+7}}\over{N_{\rm facet}^2\,\mathrm{wsNWPlanes}^2}}+81.\right)\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  \mathrm{wsGridRate(SKA1Survey)}=2.2 \times 10^{+12}\,N_{\rm facet}^2\,\left({{2777778.}\over{N_{\rm facet}^2\,\mathrm{wsNWPlanes}^2}}+81.\right)\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\end{maxima}

\subsubsection{Image-plane correction}

The image plane correction is the multiplication by the term:
\begin{equation}
  \exp{\left[ i 2 \pi  w \left(1- \sqrt{1 - l^2 - m^2}\right) \right] }
\end{equation}
This requires computation one square root and one exponential. As a
very rough guess we assume this is about the same computational
complexity as the re-projection, i.e., 50 operations.

\begin{maxima}[]
wsImCorrectTot : (50 `Ops ) * NPix**2 * Nf * Nbeam * 4 * wsNWPlanes * Nfacet**2 ;

calcTel(wsImCorrectTot, SKA1Low);
calcTel(wsImCorrectTot, SKA1Mid);
calcTel(wsImCorrectTot, SKA1Survey);

\maximaoutput*
\m  {{3200\,B_{\rm max}^2\,N_{\rm beam}\,N_{\rm f}\,\mathrm{wsNWPlanes}}\over{D_{\rm s}^2}}\;\mathrm{Ops} \\
\m  \mathrm{wsImCorrectTot(SKA1Low)}=6.7 \times 10^{+15}\,\mathrm{wsNWPlanes}\;\mathrm{Ops} \\
\m  \mathrm{wsImCorrectTot(SKA1Mid)}=1.5 \times 10^{+17}\,\mathrm{wsNWPlanes}\;\mathrm{Ops} \\
\m  \mathrm{wsImCorrectTot(SKA1Survey)}=3.3 \times 10^{+17}\,\mathrm{wsNWPlanes}\;\mathrm{Ops} \\
\end{maxima}

\subsubsection{FFT compute requirement}

The number of FFTs is simply the number of $w$-planes times the usual
number of images and facets. Since the in $w$-stacking the whole
observation is processed together the calculation here is for the
total observation (and is not a rate).

\begin{maxima}[]
wsFFTTot: (5 `Ops) * NPix **2 * log2(NPix **2)  * Nf * Nbeam * 4 *
Nfacet**2 * wsNWPlanes;
\end{maxima}

\subsubsection{Total compute requirement}

This is the computation of the total compute required (per half-cycle)
after optimising the number of $w$-planes. These numbers can be
compared directly to those in Section~\ref{sec:wsnapshot-opt-rate} --
it can be seen for the 6 hour observation the raw compute loads are
very similar. 

\begin{maxima}[]

realonly:true;

wstot: CompRate = (wsFFTTot+wsImCorrectTot)/tobs + wsGridRate;

algsys(float([diff(ev(wstot, append([NAA=9, Nfacet=1, tobs=(6*3600`s)], SKA1Low) ) / (1 `(Ops/s)), wsNWPlanes)]), [wsNWPlanes]);

float(ev(rhs(wstot), append([NAA=9, Nfacet=1, tobs=(6*3600`s), wsNWPlanes =234], SKA1Low)));

algsys(float([diff(ev(wstot, append([NAA=9, Nfacet=1, tobs=(6*3600`s)], SKA1Mid) ) / (1 `(Ops/s)), wsNWPlanes)]), [wsNWPlanes]);
float(ev(rhs(wstot), append([NAA=9, Nfacet=1, tobs=(6*3600`s), wsNWPlanes =174], SKA1Mid)));

algsys(float([diff(ev(wstot, append([NAA=9, Nfacet=1, tobs=(6*3600`s)], SKA1Survey) ) / (1 `(Ops/s)), wsNWPlanes)]), [wsNWPlanes]);
float(ev(rhs(wstot), append([NAA=9, Nfacet=1, tobs=(6*3600`s), wsNWPlanes =60], SKA1Survey)));



\maximaoutput*
\m  \mathbf{true} \\
\m  \left[ \left[ \mathrm{wsNWPlanes}=234. \right]  \right] \\
\m  6.9 \times 10^{+14}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  \left[ \left[ \mathrm{wsNWPlanes}=174. \right]  \right] \\
\m  7.4 \times 10^{+15}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\m  \left[ \left[ \mathrm{wsNWPlanes}=60. \right]  \right] \\
\m  5.3 \times 10^{+15}\;{{\mathrm{Ops}}\over{\mathrm{s}}} \\
\end{maxima}





\bibliographystyle{mn2eurl} 
\bibliography{ska.bib}

\end{document}

\end{document}

% Local Variables:
% LaTeX-command: "latex -shell-escape"
% End:
